name: Verify

on:
  pull_request:
    branches: [ master ]
  push:
    branches: [ master ]

jobs:
  find-test-groups:
    runs-on: ubuntu-latest
    outputs:
      groups: ${{ steps.find-groups.outputs.value }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Find test groups
        id: find-groups
        run: |
          groups=$(find tests/ -name "*.test.cpp" -type f | 
                   sed 's|tests/\([^/]*\).*|\1|' | sort -u |
                   sed 's|^|tests/|')
          list=$(echo "$groups" | jq -R . | jq -sc '.')
          echo "value=$list" >> $GITHUB_OUTPUT

  verify:
    runs-on: ubuntu-latest
    needs: [ find-test-groups ]
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        folder: ${{ fromJson(needs.find-test-groups.outputs.groups) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y g++ python3-pip
          pip3 install online-judge-verify-helper

      - name: Run tests in category
        timeout-minutes: 10
        run: |
          find "${{ matrix.folder }}" -name "*.test.cpp" -type f -exec oj-verify run {} \;

  verify_check:
    runs-on: ubuntu-latest
    needs: [ verify ]
    steps:
      - name: Check results
        run: |
          if [[ "${{ needs.verify.result }}" == "success" ]]; then
            echo "All tests passed"
          else
            echo "Some tests failed"
            exit 1
          fi